{% extends "base.html" %}
{% block content %}
<div class="row">
    <div class="col-lg-8">
        <h2 class="mb-4">订单 #{{ order.id }} 详情</h2>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-dark text-white">订单摘要</div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">交易时间:</dt>
                    <dd class="col-sm-9">{{ order.order_date.strftime('%Y-%m-%d %H:%M:%S') }}</dd>

                    <dt class="col-sm-3">会员:</dt>
                    <dd class="col-sm-9">
                        {% if order.member %}
                            {{ order.member.name }} ({{ order.member.phone_number }})
                        {% else %}
                            非会员
                        {% endif %}
                    </dd>

                    <dt class="col-sm-3">状态:</dt>
                    <dd class="col-sm-9"><span class="badge bg-success">{{ order.status }}</span></dd>
                </dl>
                <hr>
                <dl class="row fw-bold">
                    <dt class="col-sm-3">原始总额:</dt>
                    <dd class="col-sm-9 text-end">¥ {{ "%.2f"|format(order.original_amount) }}</dd>

                    <dt class="col-sm-3 text-danger">折扣金额:</dt>
                    <dd class="col-sm-9 text-end text-danger">- ¥ {{ "%.2f"|format(order.discount_amount) }}</dd>

                    <dt class="col-sm-3 fs-5">实付金额:</dt>
                    <dd class="col-sm-9 text-end fs-5 text-success">¥ {{ "%.2f"|format(order.final_amount) }}</dd>
                </dl>

            </div>
        </div>

        <h3 class="mt-4">购买商品明细</h3>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>商品名称</th>
                        <th>销售单价</th>
                        <th>数量</th>
                        <th>小计金额</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <td>{{ item.product.name if item.product else '商品已删除' }}</td>
                        <td>¥ {{ "%.2f"|format(item.price_at_sale) }} / {{ item.product.unit if item.product else '' }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>¥ {{ "%.2f"|format(item.line_subtotal) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow-sm mt-4 mt-lg-0 border-success">
            <div class="card-header bg-success text-white">
                <i class="bi bi-currency-dollar"></i> **订单利润分析 (管理员可见)**
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-6">订单销售额:</dt>
                    <dd class="col-sm-6 text-end">¥ {{ "%.2f"|format(order.final_amount) }}</dd>
                    <dt class="col-sm-6">总成本:</dt>
                    <dd class="col-sm-6 text-end text-danger">¥ {{ "%.2f"|format(order.final_amount - gross_profit) }}</dd>
                    <hr>
                    <dt class="col-sm-6 fs-4">毛利润:</dt>
                    <dd class="col-sm-6 text-end fs-4 text-success">¥ {{ "%.2f"|format(gross_profit) }}</dd>
                </dl>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <a href="{{ url_for('order.list_orders') }}" class="btn btn-outline-secondary">返回订单列表</a>
</div>

{% endblock %}