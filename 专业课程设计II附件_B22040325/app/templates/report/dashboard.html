{% extends "base.html" %}
{% block head_extras %}
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* 提升整体卡片美观度 */
        .card {
            border-radius: 0.75rem; /* 增加圆角 */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); /* 柔和阴影 */
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        /* 自定义 AI 分析卡片样式 - 【优化】渐变和阴影头部 */
        .ai-card-header {
            /* New: Soft gradient header */
            background: linear-gradient(135deg, #1e3a8a, #3b82f6); /* 深蓝到亮蓝的渐变 */
            color: white;
            border-bottom: none; /* 移除底部线条 */
            font-size: 1.1rem;
            padding: 1rem 1.5rem;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(30, 58, 138, 0.2); /* 匹配头部的阴影 */
        }

        .ai-card-header .btn-outline-light {
            border-color: rgba(255, 255, 255, 0.5);
            transition: background-color 0.2s;
        }

        .ai-output-box {
            padding: 1rem;
            background-color: #f9fafb; /* 【优化】非常浅的灰色背景，提供良好对比 */

            /* 【优化】更干净、略微内嵌的边框和阴影效果 */
            border: 1px solid #e5e7eb; /* 细微的浅灰色边框 */
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03), inset 0 0 5px rgba(0, 0, 0, 0.02);

            /* 文本样式保持紧凑和高对比度 */
            line-height: 1.4;
            font-size: 1rem;
            color: #1f2937; /* 【优化】使用深灰色文本，对比度更高 */
        }

        /* 覆盖默认的 text-success 样式，确保打字完成后的文本颜色正常 */
        #ai-analysis-output.text-success {
            color: #1f2937 !important; /* 最终文本使用深灰色 */
            white-space: pre-wrap;
        }

        /* 针对打字效果的 CSS */
        .typing-text::after {
            content: '|'; /* 模拟光标 */
            display: inline;
            animation: blink 0.7s infinite;
            margin-left: 3px;
            font-weight: bold;
        }

        @keyframes blink {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0;
            }
        }
    </style>
{% endblock %}
{% block content %}
    <h2 class="mb-4">数据看板</h2>

    <!-- 顶部的统计卡片保持明亮风格，但增加圆角和阴影 -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">总销售额</h5>
                    <p class="card-text fs-3">¥ {{ total_sales }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">今日销售额</h5>
                    <p class="card-text fs-3">¥ {{ today_sales }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">总订单数</h5>
                    <p class="card-text fs-3">{{ completed_orders }} 笔</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 图表部分 -->
    <div class="row">
        <div class="col-lg-12 mb-4">
            <div class="card shadow">
                <div class="card-header">近30天销售额趋势 (元)</div>
                <div class="card-body">
                    <div id="sales-trend-chart" style="height: 400px;"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header">近90天销量 Top 10</div>
                <div class="card-body">
                    <div id="quantity-rank-chart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header">近90天毛利润 Top 10 (元)</div>
                <div class="card-body">
                    <div id="profit-rank-chart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI 分析卡片 (应用新样式) -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card shadow">
                <div class="card-header ai-card-header">
                    <i class="bi bi-robot me-2"></i> AI 销售分析与建议 (DeepSeek 模型)
                    <button id="refresh-ai-btn" class="btn btn-sm btn-outline-light float-end" title="刷新分析">
                        <i class="bi bi-arrow-clockwise"></i> 刷新
                    </button>
                </div>
                <div class="card-body p-3"> <!-- 【修改 3】将 p-4 减少到 p-3 (1.5rem -> 1rem) -->
                    <div class="ai-output-box" id="ai-analysis-container">
                        <div id="ai-analysis-output" class="text-muted">
                            点击右上角刷新按钮获取 DeepSeek 模型最新分析...
                        </div>
                        <div class="spinner-border spinner-border-sm text-primary mt-2" role="status" id="ai-loading"
                             style="display:none;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="alert alert-info text-center">
        数据分析结果基于已完成订单计算。
        <a href="{{ url_for('report.export_data', data_type='sales') }}"
           class="btn btn-sm btn-outline-dark ms-3">导出销售数据</a>
        <a href="{{ url_for('report.export_data', data_type='products') }}" class="btn btn-sm btn-outline-dark ms-3">导出商品数据</a>
    </div>

{% endblock %}

{% block scripts %}
    <script>
        // --- 打字机效果函数 (保持不变，依赖CSS处理换行) ---
        function typeEffect(element, text, delay = 25) {
            let i = 0;
            element.classList.add('typing-text');

            return new Promise(resolve => {
                function type() {
                    if (i < text.length) {
                        // 使用 textContent 确保是纯文本输出，避免 XSS 风险
                        element.textContent += text.charAt(i);
                        i++;
                        setTimeout(type, delay);
                    } else {
                        element.classList.remove('typing-text');
                        resolve();
                    }
                }
                // 清空内容前先设置 textContent 以确保起始状态正确
                element.textContent = '';
                type();
            });
        }

        // --- 3. AI 分析逻辑 ---
        async function fetchAIAnalysis() {
            const outputDiv = document.getElementById('ai-analysis-output');
            const loadingSpinner = document.getElementById('ai-loading');
            const refreshBtn = document.getElementById('refresh-ai-btn');

            // 禁用按钮并清空内容，显示加载中
            refreshBtn.disabled = true;
            outputDiv.textContent = ''; // 使用 textContent 清空以避免 HTML 注入
            loadingSpinner.style.display = 'inline-block';
            outputDiv.classList.remove('text-danger', 'text-success');
            outputDiv.classList.add('text-muted'); // 恢复默认的提示文本样式

            try {
                const response = await fetch('{{ url_for('report.sales_summary_ai') }}');
                const data = await response.json();

                loadingSpinner.style.display = 'none';
                refreshBtn.disabled = false;

                if (data.success) {
                    // text-success 类仍然用于标记成功，但我们在 CSS 中将其颜色覆盖为 #1f2937 (深灰)
                    outputDiv.classList.add('text-success');
                    outputDiv.classList.remove('text-muted');
                    // data.analysis 是纯文本，由 CSS (white-space: pre-wrap) 处理换行
                    await typeEffect(outputDiv, data.analysis);

                } else {
                    outputDiv.classList.add('text-danger');
                    outputDiv.classList.remove('text-muted');
                    outputDiv.textContent = 'AI 服务调用失败或返回错误。';
                    if (data.analysis) {
                        outputDiv.textContent += `\n\n错误详情:\n${data.analysis}`;
                    }
                }
            } catch (error) {
                loadingSpinner.style.display = 'none';
                refreshBtn.disabled = false;
                outputDiv.classList.add('text-danger');
                outputDiv.classList.remove('text-muted');
                outputDiv.textContent = `请求AI分析服务时发生网络错误。`;
                console.error(error);
            }
        }

        // --- 1 & 2. ECharts 初始化 (代码不变) ---

        const salesTrendChart = echarts.init(document.getElementById('sales-trend-chart'));
        fetch('{{ url_for('report.sales_trend') }}').then(response => response.json()).then(data => {
            if (data.success) {
                salesTrendChart.setOption({
                    tooltip: {trigger: 'axis', formatter: '日期: {b}<br/>销售额: ¥{c}', axisPointer: {type: 'shadow'}},
                    xAxis: {
                        type: 'category',
                        data: data.dates,
                        axisLabel: {rotate: 45, interval: Math.floor(data.dates.length / 7)}
                    },
                    yAxis: {type: 'value', name: '销售额 (元)'},
                    series: [{
                        name: '销售额',
                        type: 'line',
                        data: data.amounts,
                        smooth: true,
                        itemStyle: {color: '#5470C6'}
                    }]
                });
            }
        });

        const quantityRankChart = echarts.init(document.getElementById('quantity-rank-chart'));
        const profitRankChart = echarts.init(document.getElementById('profit-rank-chart'));

        fetch('{{ url_for('report.product_ranking') }}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const quantityNames = data.quantity_rank.map(item => item.name);
                    const quantityValues = data.quantity_rank.map(item => item.value);

                    quantityRankChart.setOption({
                        tooltip: {trigger: 'axis'},
                        xAxis: {type: 'value'},
                        yAxis: {type: 'category', data: quantityNames.reverse()},
                        series: [{
                            name: '总销量',
                            type: 'bar',
                            data: quantityValues.reverse(),
                            itemStyle: {color: '#91CC75'}
                        }]
                    });

                    const profitNames = data.profit_rank.map(item => item.name);
                    const profitValues = data.profit_rank.map(item => item.value);

                    profitRankChart.setOption({
                        tooltip: {trigger: 'axis', formatter: '{b}: ¥{c}'},
                        xAxis: {type: 'value'},
                        yAxis: {type: 'category', data: profitNames.reverse()},
                        series: [{
                            name: '毛利润',
                            type: 'bar',
                            data: profitValues.reverse(),
                            itemStyle: {color: '#EE6666'}
                        }]
                    });
                }
            });

        // 窗口大小变化时，图表自适应
        window.addEventListener('resize', () => {
            salesTrendChart.resize();
            quantityRankChart.resize();
            profitRankChart.resize();
        });

        // 绑定刷新按钮事件
        document.getElementById('refresh-ai-btn').addEventListener('click', fetchAIAnalysis);

        // 页面加载完成后自动触发一次分析
        document.addEventListener('DOMContentLoaded', fetchAIAnalysis);

    </script>
{% endblock %}
